WITH
/* Puxa TODOS os recebimentos (sem lista fixa) e não multiplica linhas */
PAG AS (
    SELECT
        X.IDEMPRESA,
        X.IDPLANILHA,
        LISTAGG(VARCHAR(X.IDRECEBIMENTO), ',') WITHIN GROUP (ORDER BY X.IDRECEBIMENTO) AS IDRECEBIMENTO,
        LISTAGG(NULLIF(TRIM(X.DESCRRECEBIMENTO), ''), ' | ') WITHIN GROUP (ORDER BY X.IDRECEBIMENTO) AS DESCRRECEBIMENTO
    FROM (
        SELECT DISTINCT
            CR.IDEMPRESA,
            CR.IDPLANILHA,
            CR.IDRECEBIMENTO,
            FP.DESCRRECEBIMENTO
        FROM DBA.CONTAS_RECEBER CR
        LEFT JOIN DBA.FORMA_PAGREC FP
          ON FP.IDRECEBIMENTO = CR.IDRECEBIMENTO
    ) X
    GROUP BY X.IDEMPRESA, X.IDPLANILHA
),

ITENS AS (
    SELECT
        OP.IDEMPRESA,
        OP.IDORCAMENTO,
        OP.IDPRODUTO,
        OP.IDSUBPRODUTO,
        OP.QTDPRODUTO,
        OP.VALUNITBRUTO,
        OP.VALTOTLIQUIDO,
        PG.DESCRRESPRODUTO,
        OP.NUMSEQUENCIA,
        OP.IDVENDEDOR,
        OP.IDLOCALRETIRADA AS IDLOCALRETIRADA_ORC,

        /* FABRICANTE + CÓDIGO DE BARRAS unitário (do PRODUTOS_VIEW) */
        PVF.FABRICANTE   AS FABRICANTE,
        PVF.IDCODBARPROD AS CODBARRAS,

        /* >>> NOVO: CÓDIGO INTERNO DO FORNECEDOR (sem duplicar linhas) <<< */
        PF1.CODIGOINTERNOFORN,

        /* >>> ADICIONADO: código de barras da CAIXA FECHADA <<< */
        CBX.CODBARCX AS CODBARRAS_CAIXA,

        /* seção */
        PR.IDSECAO,
        S.DESCRSECAO,

        /* cliente / movimento */
        O.IDCLIFOR,
        CF.NOME AS DESCLIENTE,
        O.DTMOVIMENTO,

        /* identifica se é Pedido/Pré-nota */
        O.FLAGPRENOTA,

        /* prenota paga */
        O.FLAGPRENOTAPAGA,

        /* entrega */
        OP.TIPOENTREGA,
        (SELECT CF2.NOME
           FROM DBA.CLIENTE_FORNECEDOR CF2
          WHERE CF2.IDCLIFOR = OP.IDVENDEDOR
        ) AS NOMEVENDEDOR,

        OP.FLAGCANCELADO,

        /* chaves da prenota */
        OPREN.IDEMPRESAPRENOTA,
        OPREN.IDPLANILHAPRENOTA,

        /* local retirada via roteiro (quando existir) */
        (
            SELECT MAX(
                       CASE
                           WHEN OP2.IDLOCALRETIRADA = 0 THEN NULL
                           ELSE OP2.IDLOCALRETIRADA
                       END
                   )
            FROM DBA.ORCAMENTO_ROTEIRO_PROD ORP
            JOIN DBA.ORCAMENTO_PROD OP2
              ON OP2.IDORCAMENTO   = ORP.IDORCAMENTO
             AND OP2.IDEMPRESA    = ORP.IDEMPRESA
             AND OP2.IDPRODUTO    = ORP.IDPRODUTO
             AND OP2.IDSUBPRODUTO = ORP.IDSUBPRODUTO
             AND OP2.NUMSEQUENCIA = ORP.NUMSEQUENCIA
            JOIN DBA.ROTEIRO_ENTREGA_LOCAL REL
              ON REL.IDROTEIRO       = ORP.IDROTEIRO
             AND REL.IDLOCALRETIRADA = OP2.IDLOCALRETIRADA
             AND REL.ORDEM = 1
            JOIN DBA.LOCAL_RETIRADA LR
              ON LR.IDLOCALRETIRADA = REL.IDLOCALRETIRADA
            JOIN DBA.ESTOQUE_CADASTRO_LOCAL ECL
              ON ECL.IDLOCALESTOQUE    = LR.IDLOCALESTOQUE
             AND ECL.IDEMPRESABAIXAEST = OP2.IDEMPRESA
            WHERE ORP.IDPRODUTO          = OP.IDPRODUTO
              AND ORP.IDSUBPRODUTO       = OP.IDSUBPRODUTO
              AND ORP.NUMSEQUENCIAORIGEM = OP.NUMSEQUENCIA
              AND ORP.IDORCAMENTOORIGEM  = OP.IDORCAMENTO
              AND ORP.IDEMPRESAORIGEM    = OP.IDEMPRESA
        ) AS IDLOCALRETIRADA_ROT

    FROM DBA.ORCAMENTO O
    JOIN DBA.ORCAMENTO_PROD OP
      ON O.IDEMPRESA   = OP.IDEMPRESA
     AND O.IDORCAMENTO = OP.IDORCAMENTO
    JOIN DBA.PRODUTO_GRADE PG
      ON PG.IDPRODUTO    = OP.IDPRODUTO
     AND PG.IDSUBPRODUTO = OP.IDSUBPRODUTO

    /* join do PRODUTOS_VIEW pra pegar FABRICANTE e CODBARRAS unitário */
    LEFT JOIN DBA.PRODUTOS_VIEW PVF
      ON PVF.IDSUBPRODUTO = OP.IDSUBPRODUTO

    /* >>> NOVO: pega 1 CODIGOINTERNOFORN sem duplicar linhas <<< */
    LEFT JOIN LATERAL (
        SELECT RTRIM(PF.CODIGOINTERNOFORN) AS CODIGOINTERNOFORN
        FROM DBA.PRODUTO_FORNECEDOR PF
        WHERE PF.IDPRODUTO    = OP.IDPRODUTO
          AND PF.IDSUBPRODUTO = OP.IDSUBPRODUTO
        ORDER BY PF.IDCLIFOR
        FETCH FIRST 1 ROW ONLY
    ) PF1 ON 1=1

    /* >>> ADICIONADO: pega 1 registro de caixa fechada sem duplicar linhas <<< */
    LEFT JOIN LATERAL (
        SELECT
            CASE
                WHEN TRIM(COALESCE(PGCX.CODBARCX, '')) = '' THEN VARCHAR(PGCX.IDCODBARCX)
                ELSE PGCX.CODBARCX
            END AS CODBARCX
        FROM DBA.PRODUTO_GRADE_CODBARCX PGCX
        WHERE PGCX.IDPRODUTO    = OP.IDPRODUTO
          AND PGCX.IDSUBPRODUTO = OP.IDSUBPRODUTO
        ORDER BY
            COALESCE(PGCX.QTDMULTIPLA, 0) DESC,
            COALESCE(PGCX.DTALTERACAO, TIMESTAMP('1900-01-01-00.00.00')) DESC
        FETCH FIRST 1 ROW ONLY
    ) CBX ON 1=1

    LEFT JOIN DBA.PRODUTO PR
      ON PR.IDPRODUTO = OP.IDPRODUTO
    LEFT JOIN DBA.SECAO S
      ON S.IDSECAO = PR.IDSECAO

    LEFT JOIN DBA.CLIENTE_FORNECEDOR CF
      ON CF.IDCLIFOR = O.IDCLIFOR

    LEFT JOIN DBA.ORCAMENTO_PRE_NOTA OPREN
      ON O.IDEMPRESA   = OPREN.IDEMPRESAORCAMENTO
     AND O.IDORCAMENTO = OPREN.IDORCAMENTO

    WHERE OP.IDEMPRESA = 3
      /* mostrar somente pedidos */
      AND O.FLAGPRENOTA = 'T'
      /* últimos 31 dias até agora */
      AND O.DTMOVIMENTO >= (CURRENT TIMESTAMP - 31 DAYS)
      AND O.DTMOVIMENTO <  CURRENT TIMESTAMP
      AND NOT EXISTS (
          SELECT 1
            FROM DBA.ORCAMENTO_INFORMACAO_ADICIONAL ORCAD
           WHERE ORCAD.IDEMPRESA   = O.IDEMPRESA
             AND ORCAD.IDORCAMENTO = O.IDORCAMENTO
             AND ORCAD.IDOPERACAO > 0
      )
)

SELECT
    I.IDEMPRESA,
    I.IDORCAMENTO,
    I.IDPRODUTO,
    I.IDSUBPRODUTO,
    I.QTDPRODUTO,
    I.VALUNITBRUTO,
    I.VALTOTLIQUIDO,
    I.DESCRRESPRODUTO,
    I.NUMSEQUENCIA,
    I.IDVENDEDOR,
    COALESCE(I.IDLOCALRETIRADA_ROT, I.IDLOCALRETIRADA_ORC) AS IDLOCALRETIRADA,

    I.FABRICANTE,
    I.CODBARRAS,

    /* >>> NOVO <<< */
    I.CODIGOINTERNOFORN,

    I.CODBARRAS_CAIXA,

    I.IDSECAO,
    I.DESCRSECAO,

    I.TIPOENTREGA,
    I.NOMEVENDEDOR,

    CASE I.TIPOENTREGA
        WHEN 'I' THEN 'IMEDIATA'
        WHEN 'A' THEN 'AGUARDANDO'
        WHEN 'E' THEN 'ENCOMENDA'
        WHEN 'F' THEN 'NORMAL'
        ELSE NULL
    END AS TIPOENTREGA_DESCR,

    LRRET.DESCRLOCALRETIRADA AS LOCALRETESTOQUE,

    I.FLAGCANCELADO,
    I.IDCLIFOR,
    I.DESCLIENTE,
    I.DTMOVIMENTO,

    I.FLAGPRENOTA,

    P.IDRECEBIMENTO,
    P.DESCRRECEBIMENTO,

    I.FLAGPRENOTAPAGA

FROM ITENS I

JOIN DBA.LOCAL_RETIRADA LRRET
  ON LRRET.IDLOCALRETIRADA = COALESCE(I.IDLOCALRETIRADA_ROT, I.IDLOCALRETIRADA_ORC)
 AND LRRET.FLAGBLOLOCALRETAGUARDA = 'F'

LEFT JOIN PAG P
  ON P.IDEMPRESA  = I.IDEMPRESAPRENOTA
 AND P.IDPLANILHA = I.IDPLANILHAPRENOTA

FOR READ ONLY;
